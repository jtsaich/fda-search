# Chat Message Persistence Setup Guide

This guide explains how to set up and use the Supabase-based chat message persistence feature in the FDA RAG Assistant.

## Overview

The application now persists chat sessions and messages using Supabase as the database. Each chat session has a unique ID, and messages are stored with their full UI state including metadata, sources, and tool invocations.

## Architecture

- **Frontend**: Next.js with client-side Supabase integration
- **Database**: Supabase PostgreSQL with two tables (`chats` and `messages`)
- **Message Format**: Uses AI SDK's `UIMessage` format stored as JSONB
- **Backend**: Remains stateless - only handles streaming responses

## Setup Instructions

### 1. Create a Supabase Project

1. Go to [supabase.com](https://supabase.com) and create a new project
2. Note your project URL and anon key from Settings > API

### 2. Set Up Database Schema

1. Go to your Supabase project dashboard
2. Navigate to SQL Editor
3. Copy and paste the contents of `supabase-schema.sql`
4. Run the SQL to create the tables and indexes

The schema creates:
- `chats` table: Stores chat session metadata
- `messages` table: Stores individual messages with full UIMessage structure
- Indexes for fast queries
- Automatic timestamp updates

### 3. Configure Environment Variables

Add the following to your `.env` file (or create `.env.local` for Next.js):

```bash
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

**Important**: These environment variables must have the `NEXT_PUBLIC_` prefix to be accessible in client components.

### 4. Install Dependencies

The required Supabase client package is already listed in `package.json`:

```bash
cd frontend
npm install
```

## How It Works

### Chat Flow

1. **Creating a New Chat**
   - User navigates to `/` (home page)
   - A new chat ID is generated and stored in Supabase
   - User is redirected to `/chat/[id]`

2. **Loading an Existing Chat**
   - User navigates to `/chat/[id]`
   - Messages are loaded from Supabase
   - Chat interface initializes with previous messages

3. **Sending Messages**
   - User sends a message through ChatInterface
   - Message is sent to backend for AI response
   - Backend streams response with sources (if RAG enabled)
   - On completion, all messages are saved to Supabase

### File Structure

```
frontend/
├── app/
│   ├── page.tsx                    # Root - redirects to new chat
│   └── chat/
│       ├── page.tsx                # Creates new chat, redirects
│       └── [id]/
│           └── page.tsx            # Chat page with specific ID
├── components/
│   └── ChatInterface.tsx           # Updated with persistence logic
└── lib/
    ├── supabase.ts                 # Supabase client initialization
    └── chat-store.ts               # Chat CRUD operations

backend/ (unchanged - remains stateless)
```

### Database Schema

#### `chats` Table
- `id` (UUID, primary key): Unique chat session identifier
- `created_at` (timestamp): When chat was created
- `updated_at` (timestamp): Last message time (auto-updated)
- `title` (text, nullable): Optional chat title
- `metadata` (jsonb): Additional metadata

#### `messages` Table
- `id` (text, primary key): Message ID from AI SDK
- `chat_id` (UUID, foreign key): References parent chat
- `role` (text): 'user', 'assistant', or 'system'
- `content` (jsonb): Full UIMessage object with parts, metadata
- `created_at` (timestamp): When message was created
- `sequence_number` (integer): Order of message in conversation

## Key Implementation Details

### Message Storage

Messages are stored in their complete `UIMessage` format as JSONB:

```typescript
{
  id: "msg_123",
  role: "assistant",
  content: "...",
  parts: [
    { type: "text", text: "..." },
    { type: "source-document", title: "...", providerMetadata: {...} }
  ],
  createdAt: Date,
  // ... other AI SDK fields
}
```

This preserves:
- Text content
- Source documents with RAG metadata
- Tool invocations (future)
- Custom data parts (future)

### Server-Side ID Generation

Message IDs are generated by the backend during streaming to ensure consistency across sessions. This is important for persistence to prevent ID conflicts.

### Error Handling

- If chat loading fails, the interface starts with empty messages
- If saving fails, an error is logged but doesn't interrupt the user experience
- Database errors are caught and logged on the client side

## Testing

1. **Create a New Chat**
   ```
   Navigate to http://localhost:3000
   → Should auto-create chat and redirect to /chat/[uuid]
   ```

2. **Send Messages**
   ```
   Send a message in the chat interface
   → Check Supabase dashboard to verify message is saved
   ```

3. **Reload Chat**
   ```
   Refresh the page or navigate back to the same /chat/[uuid]
   → Previous messages should be loaded
   ```

4. **Check Database**
   ```sql
   -- View all chats
   SELECT * FROM chats ORDER BY updated_at DESC;

   -- View messages for a specific chat
   SELECT * FROM messages WHERE chat_id = 'your-chat-id' ORDER BY sequence_number;
   ```

## Future Enhancements

1. **Chat History Sidebar**
   - List of recent chats
   - Search functionality
   - Chat titles based on first message

2. **Message Validation**
   - Implement `validateUIMessages` when using tools
   - Validate metadata schemas
   - Handle schema migrations

3. **Optimizations**
   - Send only last message to backend (reduce bandwidth)
   - Implement message pagination for long chats
   - Add caching layer

4. **User Authentication**
   - Enable Supabase Row Level Security (RLS)
   - Filter chats by authenticated user
   - Add sharing capabilities

5. **Client Disconnect Handling**
   - Implement `consumeStream()` on backend
   - Track request state in database
   - Resume incomplete streams

## Troubleshooting

### "Missing Supabase environment variables"
- Ensure `.env.local` exists in the `frontend/` directory
- Variables must start with `NEXT_PUBLIC_`
- Restart the dev server after adding variables

### Messages not saving
- Check browser console for errors
- Verify Supabase credentials are correct
- Check Supabase dashboard > Database > Logs for errors
- Ensure tables were created with correct schema

### Chat not loading
- Check browser console and network tab
- Verify chat ID exists in database
- Check for CORS issues (Supabase should allow localhost by default)

### UUID Type Errors
- Ensure chat IDs are valid UUIDs (generated by `gen_random_uuid()`)
- Check that the `chats.id` column is type UUID, not TEXT

## Related Documentation

- [AI SDK Chatbot Persistence Guide](https://sdk.vercel.ai/docs/ai-sdk-ui/chatbot-persistence)
- [Supabase JavaScript Client Docs](https://supabase.com/docs/reference/javascript/introduction)
- [Next.js App Router](https://nextjs.org/docs/app)
